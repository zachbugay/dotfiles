<# prettier-ignore #>
{{- if eq .chezmoi.os "windows" }}
$stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
$userProfile = $Env:USERPROFILE
$userName = $Env:USERNAME
$env:PATH = @((Get-ItemPropertyValue 'HKCU:\Environment' -Name Path), (Get-ItemPropertyValue 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment' -Name Path))
| ForEach-Object { $_.TrimEnd(';') } | Join-String -Separator ';'

# Kubernetes Defaults
$env:EDITOR = 'nvim'

$env:DOCKER_CONFIG = [System.IO.Path]::Combine(
  $userProfile,
  '.config',
  'docker'
)

$env:KUBE_EDITOR = 'nvim'

$env:NVIM_LOG_FILE = [System.IO.Path]::Combine(
  $userProfile,
  '.local',
  '.cache',
  'nvim'
)

$env:STARSHIP_CONFIG_DIR = [System.IO.Path]::Combine(
  $userProfile,
  '.config',
  'starship'
)
$env:STARSHIP_CACHE = [System.IO.Path]::Combine(
  $userProfile,
  '.cache',
  'starship'
)
$env:STARSHIP_CONFIG = [System.IO.Path]::Combine(
  $userProfile,
  '.config',
  'starship',
  'starship.toml'
)

$env:XDG_CONFIG_HOME = [System.IO.Path]::Combine( $userProfile, '.config' )
$env:XDG_DATA_HOME = [System.IO.Path]::Combine(
  $userProfile,
  '.local',
  'share'
)
$env:XDG_STATE_HOME = [System.IO.Path]::Combine(
  $userProfile,
  '.local',
  'state'
)
$env:XDG_CACHE_HOME = [System.IO.Path]::Combine( $userProfile, '.cache' )

# Inline directory checks — 6 syscalls is faster than ThreadJob module load overhead.
foreach (
  $dir in $env:XDG_CONFIG_HOME,
  $env:XDG_DATA_HOME,
  $env:XDG_STATE_HOME,
  $env:XDG_CACHE_HOME,
  $env:STARSHIP_CONFIG_DIR,
  $env:STARSHIP_CACHE
) {
  if (-not [System.IO.Directory]::Exists($dir)) {
    $null = [System.IO.Directory]::CreateDirectory($dir)
  }
}

# Functions

function touch {
  if ([System.IO.File]::Exists($args[0])) {
    [System.IO.File]::SetLastWriteTimeUtc( $args[0], [System.DateTime]::UtcNow )
  }
  else {
    $null = [System.IO.File]::Create($args[0]).Dispose()
  }
}

function Initialize-VsDevPowerShell {
  $vsWhere = "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
  $vsPath = (& $vsWhere -latest -products * -prerelease -property installationPath).Trim()
  Import-Module (Get-ChildItem $vsPath -Recurse -File -Filter Microsoft.VisualStudio.DevShell.dll).FullName
  Enter-VsDevShell -VsInstallPath $vsPath -SkipAutomaticLocation -HostArch "arm64" -Arch "arm64"
}

function Get-ScriptDirectory {
  [CmdletBinding()]
  param()

  $null = Split-Path $MyInvocation.ScriptName
}

function Remove-AllAzureResourceGroups {
  az group list --query "[?name != 'Default-ActivityLogAlerts'].name"
  | ConvertFrom-Json
  | ForEach-Object {
    az group delete --name $_ --no-wait --yes -f 'Microsoft.Compute/virtualMachineScaleSets' -f 'Microsoft.Compute/virtualMachines' -f 'Microsoft.Databricks/workspaces'
  }
}

function Update-Scoop {
  # Update Scoop itself
  scoop update
  | scoop update *
  | scoop cleanup *
  | scoop cache rm *
  # Get `last_update` from scoop, and update the chezmoi template with the value.
  $chezmoiScoopConfigTempatePath = [System.IO.Path]::Combine($userProfile, ".local", "share", "chezmoi", ".chezmoitemplates", "default_scoop");
  $scoopConfigStringContent = Get-Content C:\Users\zacharybugay\.config\scoop\config.json;
  $scoopConfig = $scoopConfigStringContent | ConvertFrom-Json;
  $lastUpdate = "";
  if ($null -ne $scoopConfig.last_update) {
    $lastUpdate = $scoopConfig.last_update.ToString('o');
  } else {
    $lastUpdate = [System.DateTime]::Now.ToString('o');
  }
# Ignore go template syntax.
@"
{{`{{- if eq .chezmoi.os "windows" -}}`}}
{
  "shim": "kiennq",
  "scoop_repo": "git@github.com:zachbugay/Scoop.git",
  "scoop_branch": "develop",
  "default_architecture": "arm64",
  "last_update": "$lastUpdate"
}
{{`{{- end }}`}}
"@ | Out-File -FilePath $chezmoiScoopConfigTempatePath -Encoding utf8
  return $null
}

function Update-Winget {
  winget upgrade --all --force --purge
  return $null
}

function Get-Base64 {
  param([string] $Base64String)

  $bytes = [System.Convert]::FromBase64String($Base64String)
  $text = [System.Text.Encoding]::UTF8.GetString($bytes)
  Write-Information $text
}

function Remove-AllKubeConfigContexts {
  kubectl config get-users
  | ForEach-Object {
    if ($_ -ne 'NAME') {
      kubectl config delete-user $_
    }
  }
  kubectl config get-contexts
  | ForEach-Object {
    if (! $_.Contains('NAME')) {
      $contextArray = ($_.Replace( '*', '' ).Trim().Split(' '))
      kubectl config delete-context $contextArray[0]
      kubectl config delete-cluster $contextArray[3]
    }
  }
  Write-Information 'kubectl contexts cleared.'
}

function Update-StarshipInit {
  & starship init powershell --print-full-init
  | Set-Content ([System.IO.Path]::Combine( $env:STARSHIP_CACHE, 'init.ps1' ))
  Write-Host 'Starship init cache updated. Restart your shell to apply.'
}

# If a Dev Drive, or D drive exists.
$devDriveSourcePath = [System.IO.Path]::Combine(
  'D:',
  "$userName",
  'source'
)
$usingDevDrive = ([System.IO.Directory]::Exists($devDriveSourcePath))
if ($usingDevDrive) {
  function cds {
    Set-Location ($devDriveSourcePath)
  }
}

#PSReadLine
Set-PSReadLineOption -EditMode vi -PredictionSource HistoryAndPlugin -PredictionViewStyle ListView

# Aliases are slow. Replace with functions.

function open {
  Invoke-Item .
}

function l {
  Get-ChildItem -Force $args
}

function ll {
  Get-ChildItem -Force $args
}

function vi {
  nvim $args
}

function which {
  param($item) Get-Command $item
}

# Developer Setup
if ($usingDevDrive) {
  # Set the NUGET_PACKAGES environment variable
  # This path has a symlink to ~\.nuget\packages
  $env:NUGET_PACKAGES = "D:\$userName\.nuget\packages"
  $env:npm_config_cache = "D:\$userName\packages\npm"
}

# Defer heavy module loads and checks until after the first prompt renders.
$null = Register-EngineEvent -SourceIdentifier PowerShell.OnIdle -MaxTriggerCount 1 -Action {
  Import-Module Terminal-Icons -Global
  Import-Module gsudoModule -Global

  # Check if Code Insiders is installed, and map code => code-insiders.
  $_codeInsiders = [System.IO.Path]::Combine(
    $env:LOCALAPPDATA,
    'Programs',
    'Microsoft VS Code Insiders',
    'bin',
    'code-insiders.cmd'
  )
  if ([System.IO.File]::Exists($_codeInsiders)) {
    Set-Alias -Name code -Value code-insiders -Scope Global
  }
}

# Cache starship init script to avoid spawning a child process on every shell launch.
# The init output is pure function/variable definitions — safe to cache and dot-source.
# Run Update-StarshipInit after updating starship to refresh the cache.
$_starshipInitCache = [System.IO.Path]::Combine(
  $env:STARSHIP_CACHE,
  'init.ps1'
)
if ([System.IO.File]::Exists($_starshipInitCache)) {
  .$_starshipInitCache
}
else {
  & starship init powershell --print-full-init
  Set-Content ([System.IO.Path]::Combine( $env:STARSHIP_CACHE, 'init.ps1' ))
  Write-Host "Starship cache regenerated. Lines: $((Get-Content ([System.IO.Path]::Combine($env:STARSHIP_CACHE, 'init.ps1'))).Count)"
  .$_starshipInitCache
}

$stopwatch.Stop()
Write-Host "Elapsed: $($stopwatch.Elapsed.TotalSeconds) seconds"
Write-Host "Ticks: $($stopwatch.ElapsedTicks)"

# TODO: Another thing that I have done is build Shim locally, and updated scoop's shim.exe in all directories using the new shim.exe.
# There was an issue where shim.exe was coming back as a x86, and not ARM.
# https://github.com/ScoopInstaller/Shim/issues/9

# prettier-ignore
{{- end }}
