# Performance tracking
_start_time=$SECONDS

# Delete duplicates first when HISTFILE size exceeds HISTSIZE.
setopt hist_expire_dups_first

# Share history between windows.
setopt SHARE_HISTORY

# Ignore duplicated commands history list.
setopt hist_ignore_dups


# Shell options
# Typing the directory name CD's into it. Best for interactive use only. Not for scripts.
# https://zsh.sourceforge.io/Doc/Release/Options.html
setopt AUTO_CD

# A function that will import all my aliases.
_load_aliases() {
  alias ls='eza -lha --icons=auto --group-directories-first'
  alias ll='eza -lha --icons=auto --sort=name --group-directories-first'
  alias l='eza -lha --icons=auto --group-directories-first'
  alias la='eza -lha --icons=auto'
  alias ld='eza -lhD --icons=auto'
  alias lt='eza --icons=auto --tree --level=2'
  alias lta='eza --icons=auto --tree --level=3 --all'
  alias poweroff="osascript -e 'tell app \"Finder\" to shut down'"
  alias sleep="osascript -e 'tell app \"Finder\" to sleep'"
  alias gcc="gcc-15"
}

REPOS_HOME="${HOME}/source/repos"
ZSH_REPO_HOME="${XDG_CONFIG_HOME}/zsh/plugins"

# Setup directories
user_directories=(
  "${NVM_DIR}"
  "${REPOS_HOME}"
  "${ZSH_REPO_HOME}"
)

for directory in $user_directories; do
  if [ ! -d $directory ]; then
    mkdir -p $directory
  fi
done

# Plugins
zsh_plugins=(
  mattmc3/ez-compinit                         # Setup tab completions
  romkatv/zsh-no-ps2                          # Proper multi-line commands
  zdharma-continuum/fast-syntax-highlighting  # Syntax highlighting
  zsh-users/zsh-autosuggestions               # Auto-suggestions
  zsh-users/zsh-completions                   # Add completions for more cmds
  zsh-users/zsh-history-substring-search      # Up/Down to search history
)

for plugin in $zsh_plugins; do
  if ! [[ -d $ZSH_REPO_HOME/$plugin ]]; then
    git clone https://github.com/$plugin $ZSH_REPO_HOME/$plugin
  fi
  source $ZSH_REPO_HOME/$plugin/${plugin:t}.plugin.zsh
done

plugins=(
  sk    # Fuzzy Finder, rust implementation
)

# NVM Node Version Manager
export NVM_DIR="${XDG_CONFIG_HOME}/nvm"

# A conditional that ensures nvm.sh is a file, and is not empty.
# The Logical AND operator ensures subsequent commands will run only if the previous was successful.
# The . (dot) command is the source command. It is used to execute commands from a file in the current shell.
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && . "/opt/homebrew/opt/nvm/nvm.sh"  # This loads nvm
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && . "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" # This loads nvm bash_completion

# Functions for completion sources.
fpath=($ZDOTDIR/func $fpath)
fpath=("$(brew --prefix)/share/zsh/site-functions" $fpath)

export PATH="/opt/homebrew/bin:$PATH"
export PATH="/opt/homebrew/opt/rustup/bin:$PATH"

printpath() {
  tr ':' '\n' <<< "$PATH"
}
# Execute function
_load_aliases

for plugin in $plugins; do
  source <($plugin --shell zsh)
done

eval "$(starship init zsh)"

# Performance warning
_end_time=$SECONDS
_load_time=$((_end_time - _start_time))
if ((_load_time > 3)); then
  echo "⚠️ Shell startup took ${_load_time}s. Consider optimizing further."
fi
